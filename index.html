<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Saif AI - مساعد البرمجة</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000" />
  <link rel="icon" href="https://i.postimg.cc/cCLZPwnw/2dd388fc-039e-4ce1-ab35-4f9db8cc40b2.png" type="image/png">

  <meta property="og:title" content="Saif AI - مساعد البرمجة" />
  <meta property="og:description" content="مساعد ذكاء اصطناعي متخصص في البرمجة وتحليل الكود." />
  <meta property="og:image" content="https://i.postimg.cc/cCLZPwnw/2dd388fc-039e-4ce1-ab35-4f9db8cc40b2.png" />
  <meta property="og:url" content="https://apk.e-droid.net/apk/app3760290-c4w5f2.apk" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #E0E0E0; --primary-hover-color: #FFFFFF; --primary-glow-color: rgba(224, 224, 224, 0.2);
      --secondary-color: #BDBDBD;
      --bg-main-color: #000000;
      --bg-main: radial-gradient(ellipse at 50% 0%, #1a1a1a 0%, #000000 75%);
      --bg-surface: #101010; --bg-surface-raised: #1c1c1c;
      --bg-input: #1c1c1c; --text-primary: #f0f4f8; --text-secondary: #a0a8b2; --text-on-primary: #000000;
      --border-color: #2a2a2a; --border-color-light: #404040; --success-color: #4ce083; --error-color: #ff5c5c;
      --shadow-xs: 0 1px 3px rgba(0,0,0,0.5); --shadow-sm: 0 4px 6px rgba(0,0,0,0.6); --shadow-md: 0 6px 12px rgba(0,0,0,0.7);
      --border-radius-sm: 8px; --border-radius-md: 12px; --border-radius-lg: 16px; --border-radius-xl: 24px; --header-height: 52px;
    }
    * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; margin: 0; padding: 0; scrollbar-width: thin; scrollbar-color: var(--secondary-color) var(--bg-surface); }
    *::-webkit-scrollbar { width: 6px; height: 6px; }
    *::-webkit-scrollbar-track { background: var(--bg-surface); border-radius: 3px; }
    *::-webkit-scrollbar-thumb { background-color: var(--secondary-color); border-radius: 3px; }
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { background: var(--bg-main-color); display: flex; justify-content: center; align-items: center; color: var(--text-primary); }
    .container { 
        width: 100%; height: 100%; background: var(--bg-main); border: 1px solid var(--border-color); 
        border-radius: 0; display: flex; flex-direction: column; overflow: hidden; position: relative;
    }
    
    /* أنماط نافذة رمز الدخول */
    .login-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-main);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        flex-direction: column;
        padding: 2rem;
    }
    
    .login-content {
        background: var(--bg-surface-raised);
        border-radius: var(--border-radius-lg);
        padding: 2.5rem;
        max-width: 450px;
        width: 100%;
        text-align: center;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }
    
    .login-logo {
        width: 80px;
        height: 80px;
        margin-bottom: 1.5rem;
        animation: float 6s ease-in-out infinite;
    }
    
    .login-title {
        font-family: 'Aref Ruqaa', serif;
        font-size: 2rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }
    
    .login-subtitle {
        color: var(--text-secondary);
        margin-bottom: 2rem;
        line-height: 1.6;
    }
    
    .login-input {
        width: 100%;
        padding: 1rem;
        background: var(--bg-input);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        color: var(--text-primary);
        font-size: 1rem;
        margin-bottom: 1.5rem;
        text-align: center;
        transition: border-color 0.3s ease;
    }
    
    .login-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-glow-color);
    }
    
    .login-btn {
        width: 100%;
        padding: 1rem;
        background: var(--primary-color);
        color: var(--text-on-primary);
        border: none;
        border-radius: var(--border-radius-md);
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }
    
    .login-btn:hover {
        background: var(--primary-hover-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }
    
    .get-code-btn {
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        padding: 0.8rem 1.5rem;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .get-code-btn:hover {
        background: var(--bg-input);
        color: var(--text-primary);
        border-color: var(--primary-color);
    }
    
    .login-error {
        color: var(--error-color);
        margin-top: 1rem;
        font-size: 0.9rem;
        display: none;
    }
    
    .space-background {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        overflow: hidden; pointer-events: none; z-index: 0;
    }
    .moon {
        position: absolute;
        width: 60px;
        opacity: 0.6;
        filter: drop-shadow(0 0 15px rgba(224, 224, 224, 0.3));
        transition: top 1s ease-in-out, right 1s ease-in-out;
    }
    .star {
        position: absolute; background-color: white; border-radius: 50%;
        width: 2px; height: 2px; box-shadow: 0 0 8px 1px rgba(255, 255, 255, 0.7);
        animation: twinkle 5s infinite alternate;
    }
    .star:nth-of-type(1) { top: 15%; left: 20%; animation-delay: 1s; }
    .star:nth-of-type(2) { top: 25%; left: 70%; animation-delay: 2.5s; width: 1px; height: 1px; }
    .star:nth-of-type(3) { top: 50%; left: 10%; animation-delay: 0.5s; }
    .star:nth-of-type(4) { top: 60%; left: 90%; animation-delay: 3s; width: 1px; height: 1px; }
    .star:nth-of-type(5) { top: 80%; left: 40%; animation-delay: 1.8s; }
    @keyframes twinkle {
        from { opacity: 0.4; } to { opacity: 1; }
    }

    .header { background: transparent; padding: 0.4rem 0.8rem; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; z-index: 10; height: var(--header-height); position: absolute; top: 0; left: 0; right: 0; }
    .header-group { display: flex; align-items: center; gap: 0.5rem; position: relative; }
    .header .header-icon { cursor: pointer; transition: color 0.2s ease-in-out, transform 0.2s ease; color: var(--text-secondary); font-size: 1.2rem; z-index: 11; padding: 5px; }
    .settings-btn:hover { color: var(--primary-hover-color); transform: rotate(15deg) scale(1.1); }
    .share-btn-header:hover { color: var(--success-color); transform: scale(1.15); }
    .history-btn:hover { color: var(--primary-hover-color); transform: scale(1.15); }
    
    .header-astronaut-icon {
        width: 28px;
        height: 28px;
        animation: float 6s ease-in-out infinite;
    }
    .header h1 {
        font-family: 'Aref Ruqaa', serif;
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-color);
        white-space: nowrap;
    }
    .header-btn { background-color: var(--bg-surface-raised); color: var(--text-primary); border: 1px solid var(--border-color-light); padding: 0.4rem 0.7rem; border-radius: var(--border-radius-md); cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.25s ease; box-shadow: var(--shadow-xs); }
    .header-btn:hover { background-color: var(--primary-color); color: var(--text-on-primary); border-color: var(--primary-color); transform: translateY(-1px); box-shadow: var(--shadow-sm), 0 0 8px var(--primary-glow-color); }
    .dropdown-menu { display: none; position: absolute; top: calc(100% + 5px); background-color: var(--bg-surface-raised); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); box-shadow: var(--shadow-md); z-index: 100; min-width: 180px; overflow: hidden; }
    .dropdown-menu button { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 15px; background: none; border: none; color: var(--text-primary); cursor: pointer; font-size: 0.9rem; text-align: right; }
    html[dir="ltr"] .dropdown-menu button { text-align: left; }
    .dropdown-menu button:hover { background-color: var(--primary-color); color: var(--text-on-primary); }
    .dropdown-menu button i { width: 15px; text-align: center; }
    .dropdown-menu button.danger:hover { background-color: var(--error-color); color: white; }
    .chat-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; padding-top: var(--header-height); position: relative; }
    #welcomeAnimationContainer { 
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
        z-index: 1; display: none; justify-content: center; align-items: center; pointer-events: none;
    }
    .astronaut-animation-wrapper {
        position: relative;
        width: 150px;
        height: 150px;
        display: flex;
        justify-content: center;
        align-items: center;
        animation: fadeIn 1.5s ease-out forwards;
        opacity: 0;
    }
    .welcome-astronaut {
        width: 100px;
        height: 100px;
        animation: float 6s ease-in-out infinite;
    }
    @keyframes fadeIn { to { opacity: 0.7; } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    .chat-container { flex: 1; padding: 1.5rem 1rem 150px 1rem; overflow-y: auto; background: transparent; scroll-behavior: smooth; min-height: 0; }
    .message { max-width: 85%; margin-bottom: 1rem; display: flex; flex-direction: column; animation: messageAppear 0.2s ease-out; word-wrap: break-word; white-space: pre-wrap; line-height: 1.5; }
    @keyframes messageAppear { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message-content { padding: 0.5rem; font-size: 0.95rem; }
    .message-content .sent-image { display: block; max-width: 250px; width: 100%; border-radius: var(--border-radius-md); margin-top: 10px; cursor: pointer; border: 1px solid var(--border-color-light); transition: transform 0.2s ease; }
    .message-content .sent-image:hover { transform: scale(1.03); }
    .typing-indicator span { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background-color: var(--text-secondary); margin: 0 2px; animation: typing-bounce 1.4s infinite ease-in-out both; }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; } .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing-bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    .message-header { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.3rem; display: flex; align-items: center; gap: 8px; font-weight: 500; }
    .delete-btn { color: var(--text-secondary); font-size: 0.7rem; cursor: pointer; transition: color 0.2s, transform 0.2s; opacity: 0.4; padding: 3px 5px; }
    .message:hover .delete-btn { opacity: 0.8; }
    .delete-btn:hover { opacity: 1; color: var(--error-color); transform: scale(1.15); }
    .message.user { margin-left: auto; align-items: flex-end; }
    .message.user .message-header { flex-direction: row-reverse; }
    .message.bot { margin-right: auto; align-items: flex-start; }
    html[dir="ltr"] .message.user { margin-right: auto; margin-left: 0; align-items: flex-start; }
    html[dir="ltr"] .message.bot { margin-left: auto; margin-right: 0; align-items: flex-end; }
    .message.user .message-content { color: #e5e7eb; }
    .message.bot .message-content { color: var(--text-primary); }
    .message.bot .message-content strong { color: var(--primary-color); }
    .message-actions { margin-top: 8px; display: flex; gap: 6px; padding: 0 6px; flex-wrap: wrap; }
    .message.user .message-actions { justify-content: flex-end; }
    .message-actions button { background: var(--bg-surface-raised); border: 1px solid var(--border-color); cursor: pointer; font-size: 0.8rem; padding: 4px 8px; color: var(--text-secondary); transition: all 0.25s ease; border-radius: var(--border-radius-sm); display: flex; align-items: center; gap: 4px; }
    .message-actions button:hover { color: var(--text-on-primary); background-color: var(--primary-color); border-color: var(--primary-color); box-shadow: 0 0 10px var(--primary-glow-color); }
    .chat-input-area { position: absolute; bottom: 0; left: 0; right: 0; background: transparent; padding: 0.8rem 1rem; z-index: 5; }
    .chat-input-area::before { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 150px; background: linear-gradient(to top, var(--bg-main-color) 20%, transparent 100%); pointer-events: none; z-index: 4; }
    
    .chat-input-container {
        max-width: 800px;
        margin: 0 auto;
        display: flex;
        align-items: flex-end;
        gap: 8px;
        position: relative;
        z-index: 5;
    }
    #sendOrVoiceBtn {
        background: #ffffff;
        color: #333;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.25s ease;
        flex-shrink: 0;
        box-shadow: var(--shadow-sm);
        border: none;
    }
    #sendOrVoiceBtn:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow-md);
    }
    #sendOrVoiceBtn.recording {
        background-color: var(--error-color);
        color: white;
    }
    .chat-input-wrapper {
        position: relative;
        flex-grow: 1;
        background: var(--bg-input);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-xl);
        transition: border-color 0.25s ease, box-shadow 0.25s ease;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-md);
    }
    .chat-input-wrapper:focus-within { border-color: var(--primary-color); box-shadow: var(--shadow-md), 0 0 0 3px var(--primary-glow-color); }
    .chat-input-main { display: flex; align-items: flex-end; width: 100%; }
    .chat-input-wrapper textarea { flex: 1; padding: 12px 0; margin: 0 5px; border: none; resize: none; font-size: 0.95rem; outline: none; background: transparent; color: var(--text-primary); max-height: 120px; line-height: 1.5; }
    .chat-input-wrapper textarea::placeholder { color: var(--text-secondary); opacity: 0.6; }
    #imagePreviewContainer { display: none; padding: 8px 12px 0; gap: 10px; flex-wrap: wrap; }
    .preview-item { position: relative; }
    .preview-item img { width: 60px; height: 60px; border-radius: var(--border-radius-sm); object-fit: cover; }
    .remove-preview-btn { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; background-color: var(--error-color); color: white; border: none; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 0.8rem; }
    .chat-input-btn { background: transparent; border: none; color: var(--text-secondary); width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.1rem; transition: all 0.25s ease; flex-shrink: 0; }
    .chat-input-btn:hover { color: var(--text-primary); transform: scale(1.1); }
    
    .voice-indicator { display: none; align-items: center; justify-content: center; position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: var(--bg-surface-raised); color: var(--text-primary); padding: 8px 16px; border-radius: var(--border-radius-md); box-shadow: var(--shadow-md); gap: 8px; z-index: 10; opacity: 0; transition: opacity 0.3s ease; }
    .voice-indicator.active { display: flex; opacity: 1; }
    .voice-indicator i { color: var(--error-color); animation: pulseMic 1.5s infinite ease-in-out; }
    @keyframes pulseMic { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

    #suggestionsContainer { display: none; flex-direction: row; gap: 8px; padding-bottom: 8px; max-width: 800px; margin: 0 auto; overflow-x: auto; white-space: nowrap; scrollbar-width: none; }
    #suggestionsContainer::-webkit-scrollbar { display: none; }
    .suggestion-btn { background-color: var(--bg-surface-raised); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 6px 12px; font-size: 0.85rem; border-radius: var(--border-radius-xl); cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; }
    .suggestion-btn:hover { background-color: var(--bg-input); border-color: var(--primary-color); color: var(--text-primary); transform: translateY(-2px); }
    .ai-disclaimer { font-size: 0.75rem; color: var(--text-secondary); text-align: center; padding: 0.5rem 1rem 0; max-width: 800px; margin: 0 auto; line-height: 1.5; position: relative; z-index: 5; }
    .fullscreen-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 1001; flex-direction: column; justify-content: center; align-items: center; }
    #cameraView, #previewCanvas { width: 100%; height: 100%; object-fit: cover; }
    .camera-controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; align-items: center; z-index: 1002; }
    .shutter-btn { width: 70px; height: 70px; border-radius: 50%; background-color: #fff; border: 4px solid #000; cursor: pointer; }
    .camera-action-btn { background: rgba(0,0,0,0.5); color: #fff; border: none; padding: 15px 25px; border-radius: var(--border-radius-md); font-size: 1rem; cursor: pointer; }
    .shutter-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; opacity: 0; animation: flash 0.5s ease; pointer-events: none; z-index: 1003; }
    @keyframes flash { from { opacity: 0.7; } to { opacity: 0; } }
    .share-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .share-modal-content { max-width: 450px; width: 90%; background: #1c1c1c; padding: 30px; border: 1px solid var(--border-color-light); border-radius: var(--border-radius-lg); text-align: center; display: flex; flex-direction: column; align-items: center; position: relative; box-shadow: var(--shadow-lg); }
    .share-modal-content h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; color: var(--text-primary); }
    .share-modal-content > p { font-size: 1rem; color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6; }
    .share-link-container { display: flex; margin-bottom: 20px; width: 100%; }
    .share-link-container input { flex-grow: 1; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary); padding: 12px 15px; border-radius: 0 8px 8px 0; font-size: 0.95rem; outline: none; }
    .share-link-container button { border: 1px solid var(--primary-color); background-color: var(--primary-color); color: var(--text-on-primary); padding: 12px 18px; border-radius: 8px 0 0 8px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; }
    .share-link-container button:hover { background-color: var(--primary-hover-color); }
    .share-divider { width: 80%; height: 1px; background: var(--border-color); margin: 25px auto; border: none; }
    .social-share-buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
    .social-share-buttons .share-icon { width: 48px; height: 48px; border-radius: 50%; background: var(--bg-surface-raised); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; text-decoration: none; transition: all 0.3s ease; }
    .social-share-buttons .share-icon:hover { color: #fff; transform: translateY(-4px); box-shadow: var(--shadow-md); }
    .share-icon.whatsapp:hover { background-color: #25D366; } .share-icon.twitter:hover { background-color: #1DA1F2; } .share-icon.telegram:hover { background-color: #0088cc; } .share-icon.facebook:hover { background-color: #1877F2; }
    .qr-code-container { margin-top: 15px; }
    .qr-code-container img { background: #fff; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); }
    .qr-code-container p { color: var(--text-secondary); font-size: 0.9rem; margin-top: 8px; }
    .close-share-modal { position: absolute; top: 15px; left: 15px; font-size: 1.8rem; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; }
    .close-share-modal:hover { color: var(--text-primary); transform: rotate(90deg); }
    .history-sidebar { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background-color: var(--bg-surface); border-left: 1px solid var(--border-color); z-index: 1001; transition: right 0.3s ease-in-out; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); }
    html[dir="ltr"] .history-sidebar { right: auto; left: -300px; border-left: none; border-right: 1px solid var(--border-color); transition: left 0.3s ease-in-out; }
    .history-sidebar.open { right: 0; }
    html[dir="ltr"] .history-sidebar.open { left: 0; }
    .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1000; backdrop-filter: blur(2px); }
    .sidebar-overlay.open { display: block; }
    .history-header { padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
    .history-header h3 { font-size: 1.1rem; color: var(--text-primary); }
    #closeHistoryBtn { background: none; border: none; font-size: 1.8rem; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
    #closeHistoryBtn:hover { color: var(--text-primary); transform: rotate(90deg); }
    .new-chat-btn { display: flex; align-items: center; gap: 10px; width: calc(100% - 2rem); margin: 1rem; padding: 0.8rem; background-color: var(--bg-input); border: 1px solid var(--border-color-light); border-radius: var(--border-radius-md); color: var(--text-primary); cursor: pointer; transition: all 0.2s; font-size: 0.95rem; }
    .new-chat-btn:hover { background-color: var(--primary-color); color: var(--text-on-primary); border-color: var(--primary-color); }
    #historyList { list-style: none; flex-grow: 1; overflow-y: auto; padding: 0 1rem; }
    #historyList li { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0.6rem; border-radius: var(--border-radius-sm); margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s; background-color: var(--bg-surface-raised); border: 1px solid transparent; }
    #historyList li:hover { background-color: var(--bg-input); }
    #historyList li.active { background-color: var(--bg-input); border-color: var(--primary-color); }
    .history-item-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; font-size: 0.9rem; }
    .delete-history-item-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0 5px; font-size: 0.9rem; opacity: 0.5; transition: all 0.2s; }
    #historyList li:hover .delete-history-item-btn { opacity: 1; }
    .delete-history-item-btn:hover { color: var(--error-color); transform: scale(1.2); }
    .fullscreen-image-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
    #fullscreenImageView { max-width: 90%; max-height: 85%; object-fit: contain; border-radius: var(--border-radius-md); box-shadow: 0 0 40px rgba(0,0,0,0.5); }
    .close-overlay-btn { position: absolute; top: 20px; right: 30px; font-size: 2.5rem; font-weight: bold; color: #fff; cursor: pointer; transition: transform 0.2s ease; }
    .close-overlay-btn:hover { transform: scale(1.2); }
    
    /* New Styles for Code Container */
    .code-container {
        background: #1e1e1e;
        border: 1px solid #333;
        border-radius: var(--border-radius-md);
        padding: 12px;
        margin: 8px 0;
        position: relative;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        line-height: 1.4;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-all;
    }
    .code-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 6px;
        border-bottom: 1px solid #333;
    }
    .code-language {
        color: var(--success-color);
        font-weight: bold;
        font-size: 0.75rem;
    }
    .copy-code-btn {
        background: var(--primary-color);
        color: var(--text-on-primary);
        border: none;
        padding: 4px 8px;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-size: 0.7rem;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .copy-code-btn:hover {
        background: var(--primary-hover-color);
        transform: scale(1.05);
    }
    .copy-code-btn.copied {
        background: var(--success-color);
    }
    
    @media (max-width: 480px) { 
      .header h1 { font-size: 1.1rem; } .message { max-width: 95%; } 
      .chat-input-wrapper textarea { padding: 10px 0; margin: 0 2px; font-size: 0.9rem; } 
      #sendOrVoiceBtn { width: 44px; height: 44px; font-size: 1.1rem;}
      .suggestion-btn { padding: 8px 10px; font-size: 0.8rem; }
      .code-container { padding: 8px; font-size: 0.8rem; }
      .login-content { padding: 2rem 1.5rem; }
      .login-title { font-size: 1.7rem; }
    }
  </style>
</head>
<body>
  <!-- نافذة رمز الدخول -->
  <div id="loginModal" class="login-modal">
    <div class="space-background">
        <img src="https://i.postimg.cc/Y9qbgjmX/moon-PNG20.png" alt="Moon" class="moon" id="login-moon-img">
        <div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div>
    </div>
    <div class="login-content">
        <img src="https://i.postimg.cc/15L2K4wT/1000137153.png" alt="Saif AI" class="login-logo">
        <h1 class="login-title">Saif AI</h1>
        <p class="login-subtitle">مساعد البرمجة المتخصص - إجابات سريعة ومختصرة</p>
        
        <input type="text" id="loginCodeInput" class="login-input" placeholder="أدخل رمز الدخول" maxlength="20">
        <button id="loginSubmitBtn" class="login-btn">دخول إلى المنصة</button>
        
        <p style="color: var(--text-secondary); margin: 1.5rem 0; font-size: 0.9rem;">إذا لم يكن لديك رمز الدخول</p>
        <a href="https://saifheny.github.io/subscription/" target="_blank" class="get-code-btn">
            <i class="fas fa-key"></i> الحصول على رمز الدخول
        </a>
        
        <p id="loginError" class="login-error">
            <i class="fas fa-exclamation-circle"></i> رمز الدخول غير صحيح. يرجى المحاولة مرة أخرى.
        </p>
    </div>
  </div>

  <div class="container" style="display: none;">
    <div id="space-background" class="space-background">
        <img src="https://i.postimg.cc/Y9qbgjmX/moon-PNG20.png" alt="Moon" class="moon" id="moon-img">
        <div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div>
    </div>
    
    <header class="header" dir="rtl">
      <div class="header-group">
        <img src="https://i.postimg.cc/15L2K4wT/1000137153.png" alt="Astronaut Icon" class="header-astronaut-icon">
        <h1 id="botName">مساعد البرمجة</h1>
      </div>
      <div id="headerIcons" class="header-group">
        <i class="fas fa-share-alt header-icon share-btn-header" id="shareBtn"></i>
        <i class="fas fa-bars header-icon history-btn" id="historyBtn"></i>
        <div id="settingsSelector">
            <i class="fas fa-cog header-icon settings-btn" id="settingsBtn"></i>
            <div id="settingsDropdown" class="dropdown-menu">
                <button id="deleteCurrentChatBtn" class="danger"><i class="fas fa-trash"></i> <span>حذف المحادثة</span></button>
            </div>
        </div>
      </div>
    </header>

    <div class="chat-wrapper" id="chatWrapper"> 
        <div id="welcomeAnimationContainer">
            <div class="astronaut-animation-wrapper">
                <img src="https://i.postimg.cc/15L2K4wT/1000137153.png" alt="Saif AI" class="welcome-astronaut"/>
            </div>
        </div>
        <div id="chatContainer" class="chat-container"></div>
        <div class="chat-input-area"> 
            <div id="suggestionsContainer"></div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                  <div id="imagePreviewContainer"></div>
                  <div class="chat-input-main">
                    <textarea id="userInput" rows="1" dir="auto" placeholder="اكتب سؤالك البرمجي هنا..."></textarea>
                    <button class="chat-input-btn" id="toggleUploadBtn"><i class="fas fa-paperclip"></i></button>
                  </div>
                  <input id="imageUpload" type="file" accept="image/*" style="display: none;" />
                </div>
                <button id="sendOrVoiceBtn"><i class="fas fa-microphone"></i></button>
            </div>

            <div class="voice-indicator" id="voiceIndicator"><i class="fas fa-microphone"></i><span>جاري الاستماع...</span></div>

            <div id="aiDisclaimer" class="ai-disclaimer">مساعد برمجي متخصص - إجابات مختصرة وسريعة</div>
        </div>
    </div>
  </div>
  
  <div id="historySidebar" class="history-sidebar">
    <div class="history-header"><h3>سجل المحادثات</h3><button id="closeHistoryBtn">&times;</button></div>
    <button id="newChatBtn" class="new-chat-btn"><i class="fas fa-plus"></i> <span>محادثة جديدة</span></button>
    <ul id="historyList"></ul>
  </div>
  <div id="sidebar-overlay" class="sidebar-overlay"></div>

  <div class="fullscreen-overlay" id="cameraOverlay">
    <video id="cameraView" autoplay playsinline></video>
    <div class="camera-controls">
        <button id="cancelCameraBtn" class="camera-action-btn">إلغاء</button>
        <button id="captureBtn" class="shutter-btn"></button>
    </div>
    <div class="shutter-flash"></div>
  </div>

  <div class="fullscreen-overlay" id="previewOverlay">
      <canvas id="previewCanvas"></canvas>
      <div class="camera-controls">
          <button id="retakeBtn" class="camera-action-btn">إعادة</button>
          <button id="usePhotoBtn" class="camera-action-btn">استخدام الصورة</button>
      </div>
  </div>

  <div id="shareModal" class="share-modal">
    <div class="share-modal-content">
      <span class="close-share-modal" id="closeShareModal">&times;</span><h2>مشاركة التطبيق</h2><p>ساعدنا على النمو بمشاركة التطبيق مع أصدقائك!</p>
      <div class="share-link-container"><button id="copyLinkBtn"><i class="fas fa-copy"></i> <span>نسخ</span></button><input type="text" value="https://apk.e-droid.net/apk/app3760290-c4w5f2.apk" id="shareLinkInput" readonly></div>
      <hr class="share-divider">
      <div class="social-share-buttons">
          <a href="#" target="_blank" class="share-icon whatsapp" id="whatsapp-share"><i class="fab fa-whatsapp"></i></a><a href="#" target="_blank" class="share-icon twitter" id="twitter-share"><i class="fab fa-twitter"></i></a><a href="#" target="_blank" class="share-icon telegram" id="telegram-share"><i class="fab fa-telegram-plane"></i></a><a href="#" target="_blank" class="share-icon facebook" id="facebook-share"><i class="fab fa-facebook-f"></i></a>
      </div>
      <div class="qr-code-container"><img id="qr-code-img" src="" alt="QR Code" width="140" height="140"><p>أو امسح الرمز للمشاركة</p></div>
    </div>
  </div>

  <div id="imageOverlay" class="fullscreen-image-overlay">
    <span id="closeOverlayBtn" class="close-overlay-btn">&times;</span>
    <img id="fullscreenImageView" src="" alt="Full screen image view">
  </div>

  <script>
    // ================== START: CONFIGURATION ==================
    const geminiApiKey = "AIzaSyArAURCzYl1uxSJxvF7r5Ad-W5kaaz4ANw";
    const ACCESS_CODE = "saifSAR";
    // ================== END: CONFIGURATION ==================

    // عناصر واجهة رمز الدخول
    const loginModal = document.getElementById('loginModal');
    const loginCodeInput = document.getElementById('loginCodeInput');
    const loginSubmitBtn = document.getElementById('loginSubmitBtn');
    const loginError = document.getElementById('loginError');
    const mainContainer = document.querySelector('.container');

    // دالة التحقق من رمز الدخول
    function checkAccessCode() {
        const savedCode = localStorage.getItem('saifAiAccessCode');
        return savedCode === ACCESS_CODE;
    }

    // دالة حفظ رمز الدخول
    function saveAccessCode() {
        localStorage.setItem('saifAiAccessCode', ACCESS_CODE);
    }

    // دالة إظهار نافذة الدخول
    function showLoginModal() {
        loginModal.style.display = 'flex';
        mainContainer.style.display = 'none';
        randomizeLoginMoonPosition();
    }

    // دالة إخفاء نافذة الدخول
    function hideLoginModal() {
        loginModal.style.display = 'none';
        mainContainer.style.display = 'flex';
    }

    // دالة عشوائية لموضع القمر في نافذة الدخول
    function randomizeLoginMoonPosition() {
        const moon = document.getElementById('login-moon-img');
        if (!moon) return;
        const top = Math.random() * 20 + 10;
        const right = Math.random() * 30 + 10;
        moon.style.top = `${top}%`;
        moon.style.right = `${right}%`;
    }

    // التحقق من رمز الدخول عند الضغط على زر الدخول
    loginSubmitBtn.addEventListener('click', function() {
        const enteredCode = loginCodeInput.value.trim();
        
        if (enteredCode === ACCESS_CODE) {
            saveAccessCode();
            hideLoginModal();
            initializeApp();
        } else {
            loginError.style.display = 'block';
            loginCodeInput.style.borderColor = 'var(--error-color)';
            loginCodeInput.style.animation = 'shake 0.5s';
            setTimeout(() => {
                loginCodeInput.style.animation = '';
            }, 500);
        }
    });

    // السماح بالدخول عند الضغط على Enter
    loginCodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loginSubmitBtn.click();
        }
    });

    // إعادة تعيين حالة الخطأ عند الكتابة
    loginCodeInput.addEventListener('input', function() {
        loginError.style.display = 'none';
        loginCodeInput.style.borderColor = 'var(--border-color)';
    });

    // التحقق من رمز الدخول عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
        if (checkAccessCode()) {
            hideLoginModal();
            initializeApp();
        } else {
            showLoginModal();
        }
    });

    // إضافة تأثير الاهتزاز في CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    `;
    document.head.appendChild(style);

    // المتغيرات الأساسية
    const chatWrapper = document.getElementById("chatWrapper"); 
    const chatContainer = document.getElementById("chatContainer"); 
    const userInput = document.getElementById("userInput"); 
    const imageUploadInput = document.getElementById("imageUpload"); 
    const toggleUploadBtn = document.getElementById("toggleUploadBtn"); 
    const sendOrVoiceBtn = document.getElementById("sendOrVoiceBtn"); 
    const voiceIndicator = document.getElementById('voiceIndicator');
    const shareBtn = document.getElementById('shareBtn'); 
    const shareModal = document.getElementById('shareModal'); 
    const closeShareModalBtn = document.getElementById('closeShareModal'); 
    const copyLinkBtn = document.getElementById('copyLinkBtn'); 
    const shareLinkInput = document.getElementById('shareLinkInput'); 
    const settingsBtn = document.getElementById('settingsBtn'); 
    const settingsDropdown = document.getElementById('settingsDropdown'); 
    const deleteCurrentChatBtn = document.getElementById('deleteCurrentChatBtn'); 
    const historyBtn = document.getElementById('historyBtn'); 
    const historySidebar = document.getElementById('historySidebar'); 
    const sidebarOverlay = document.getElementById('sidebar-overlay'); 
    const closeHistoryBtn = document.getElementById('closeHistoryBtn'); 
    const newChatBtn = document.getElementById('newChatBtn'); 
    const historyList = document.getElementById('historyList'); 
    const welcomeAnimation = document.getElementById('welcomeAnimationContainer');
    const cameraOverlay = document.getElementById('cameraOverlay'); 
    const previewOverlay = document.getElementById('previewOverlay'); 
    const cameraView = document.getElementById('cameraView'); 
    const previewCanvas = document.getElementById('previewCanvas'); 
    const captureBtn = document.getElementById('captureBtn'); 
    const cancelCameraBtn = document.getElementById('cancelCameraBtn'); 
    const usePhotoBtn = document.getElementById('usePhotoBtn'); 
    const retakeBtn = document.getElementById('retakeBtn'); 
    const imagePreviewContainer = document.getElementById('imagePreviewContainer'); 

    const botName = "مساعد البرمجة"; 
    const localStorageKeyAllChats = "saifAiProgrammingChats_v1"; 
    const localStorageKeyLastSession = "saifAiLastProgrammingSession_v1"; 
    
    let allChatSessions = []; 
    let messages = []; 
    let attachedFiles = []; 
    let currentChatId = null; 
    let cameraStream = null;
    let recognition;
    let isListening = false;

    const spaceBackground = document.getElementById('space-background');

    function randomizeMoonPosition() {
        const moon = document.getElementById('moon-img');
        if (!moon) return;
        const top = Math.random() * 15 + 5;
        const right = Math.random() * 25 + 5;
        moon.style.top = `${top}%`;
        moon.style.right = `${right}%`;
    }

    function initializeApp() { 
        mainContainer.style.display = 'flex';
        
        loadAllChatSessions(); 
        randomizeMoonPosition();
        
        // إعداد الأحداث
        setupEventListeners();
        
        // إعداد التعرف على الصوت
        initSpeechRecognition();
    }

    function setupEventListeners() {
        // مشاركة
        shareBtn.addEventListener('click', () => { 
            const shareUrl = shareLinkInput.value; 
            const shareText = "اكتشف مساعد البرمجة Saif AI - إجابات سريعة ومختصرة!"; 
            const qrCodeImg = document.getElementById('qr-code-img');
            const whatsappShare = document.getElementById('whatsapp-share'); 
            const twitterShare = document.getElementById('twitter-share'); 
            const telegramShare = document.getElementById('telegram-share'); 
            const facebookShare = document.getElementById('facebook-share'); 
            
            qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent(shareUrl)}&bgcolor=1c1c1c&color=ffffff&qzone=1`; 
            whatsappShare.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText + " " + shareUrl)}`; 
            twitterShare.href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`; 
            telegramShare.href = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`; 
            facebookShare.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`; 
            shareModal.style.display = 'flex'; 
        }); 
        
        closeShareModalBtn.addEventListener('click', () => { shareModal.style.display = 'none'; }); 
        copyLinkBtn.addEventListener('click', copyShareLink); 
        
        // رفع الصور
        toggleUploadBtn.addEventListener('click', () => imageUploadInput.click()); 
        
        // الكاميرا
        captureBtn.addEventListener('click', captureImage); 
        retakeBtn.addEventListener('click', () => { previewOverlay.style.display = 'none'; cameraOverlay.style.display = 'flex'; }); 
        cancelCameraBtn.addEventListener('click', closeCamera); 
        usePhotoBtn.addEventListener('click', handleCameraPhotoSubmission); 
        
        // المحادثات
        deleteCurrentChatBtn.addEventListener('click', deleteCurrentChat); 
        historyBtn.addEventListener('click', openHistorySidebar); 
        closeHistoryBtn.addEventListener('click', closeHistorySidebar); 
        sidebarOverlay.addEventListener('click', closeHistorySidebar); 
        newChatBtn.addEventListener('click', () => { loadChat(null); closeHistorySidebar(); }); 
        
        // الإدخال
        userInput.addEventListener("keydown", (e) => { 
            if(e.key==="Enter"&&!e.shiftKey) { 
                e.preventDefault(); 
                sendMessage();
            }
        }); 
        
        userInput.addEventListener("input", () => { 
            autoResizeTextarea(); 
            updateSendOrVoiceButton();
            updateInitialViewState(); 
        }); 
        
        // الإعدادات
        settingsBtn.addEventListener('click', (e) => { 
            e.stopPropagation(); 
            toggleDropdown(settingsDropdown); 
        }); 
        
        document.addEventListener('click', () => { 
            settingsDropdown.style.display = 'none'; 
        }); 

        imageUploadInput.addEventListener('change', handleFileSelect);

        window.addEventListener('click', (event) => { if (event.target == shareModal) shareModal.style.display = 'none'; });
        
        const imageOverlay = document.getElementById('imageOverlay');
        document.getElementById('closeOverlayBtn').onclick = () => { imageOverlay.style.display = 'none'; };
        imageOverlay.onclick = (e) => { if (e.target.id === 'imageOverlay') { imageOverlay.style.display = 'none'; } };
    }

    function toggleDropdown(menu) { 
        const isVisible = menu.style.display === 'block'; 
        settingsDropdown.style.display = 'none'; 
        if (!isVisible) { 
            menu.style.display = 'block'; 
        } 
    }

    function copyShareLink() { 
        shareLinkInput.select(); 
        navigator.clipboard.writeText(shareLinkInput.value).then(() => { 
            const copyBtnText = document.querySelector('#copyLinkBtn span');
            const copyBtnIcon = copyLinkBtn.querySelector('i');
            const originalText = copyBtnText.textContent; 
            copyBtnText.textContent = "تم النسخ!"; 
            copyBtnIcon.className = "fas fa-check"; 
            setTimeout(() => { 
                copyBtnText.textContent = originalText; 
                copyBtnIcon.className = "fas fa-copy"; 
            }, 2000); 
        }); 
    }

    function initSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'ar-SA';
            
            recognition.onstart = () => {
                isListening = true;
                sendOrVoiceBtn.classList.add('recording');
                voiceIndicator.classList.add('active');
            };
            
            recognition.onresult = (event) => {
                let transcript = Array.from(event.results).map(result => result[0].transcript).join('');
                userInput.value = transcript;
                if(event.results[0].isFinal) {
                    autoResizeTextarea();
                    updateSendOrVoiceButton();
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                stopListening();
            };
            
            recognition.onend = () => {
                stopListening();
            };
        } else {
            // إذا لم يكن مدعوماً، إخفاء المؤشر الصوتي
            sendOrVoiceBtn.style.display = 'none';
        }
    }

    function toggleListening() {
        if (!recognition) return;
        if (isListening) {
            recognition.stop();
        } else {
            try {
                userInput.value = "";
                autoResizeTextarea();
                updateSendOrVoiceButton();
                recognition.start();
            } catch (e) {
                stopListening();
            }
        }
    }

    function stopListening() {
        if(isListening) {
            isListening = false;
            sendOrVoiceBtn.classList.remove('recording');
            voiceIndicator.classList.remove('active');
        }
    }

    function updateSendOrVoiceButton() {
        const hasText = userInput.value.trim().length > 0 || attachedFiles.length > 0;
        if (hasText) {
            sendOrVoiceBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendOrVoiceBtn.onclick = sendMessage;
        } else {
            sendOrVoiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            sendOrVoiceBtn.onclick = toggleListening;
        }
    }

    function loadAllChatSessions() {
        try {
            const stored = localStorage.getItem(localStorageKeyAllChats);
            allChatSessions = stored ? JSON.parse(stored) : [];
        } catch (e) {
            allChatSessions = [];
        }

        let lastSessionId = null;
        try {
            const storedLast = localStorage.getItem(localStorageKeyLastSession);
            if (storedLast) lastSessionId = JSON.parse(storedLast);
        } catch (e) {}
        
        const lastSessionExists = allChatSessions.some(s => s.id === lastSessionId);
        if (lastSessionExists) {
            loadChat(lastSessionId);
        } else {
            const latestChatId = allChatSessions.length > 0 ? allChatSessions[0].id : null;
            loadChat(latestChatId);
        }
    }

    function saveAllChatSessionsToLocalStorage() {
        if (currentChatId) {
            const session = allChatSessions.find(s => s.id === currentChatId);
            if (session) {
                session.messages = messages;
            }
        }
        localStorage.setItem(localStorageKeyAllChats, JSON.stringify(allChatSessions));
        if (currentChatId) {
            localStorage.setItem(localStorageKeyLastSession, JSON.stringify(currentChatId));
        }
    }
    
    function loadChat(chatId) { 
        currentChatId = chatId; 
        if (chatId === null) { 
            messages = []; 
            addWelcomeMessage(); 
        } else { 
            const session = allChatSessions.find(s => s.id === chatId); 
            if (session) { 
                messages = session.messages; 
            } else { 
                messages = []; 
                addWelcomeMessage(); 
                currentChatId = null; 
            } 
        } 
        refreshChat(); 
    }

    function addWelcomeMessage() { 
        const welcomeMsgText = "مرحباً! أنا مساعدك البرمجي المتخصص. يمكنني مساعدتك في:\n• تحليل الأخطاء البرمجية\n• شرح الكود\n• تحسين الكود\n• الإجابة على أسئلة البرمجة\n\nاطرح سؤالك البرمجي وسأجيب بسرعة وإيجاز."; 
        if (messages.length === 0 || !messages.some(m => m.isInitialWelcome)) { 
            messages.unshift({ sender: "bot", text: welcomeMsgText, images: [], isInitialWelcome: true }); 
        } 
    }

    function addMessage(sender, text, images = [], isSystemMessage = false) { 
        if (currentChatId === null && sender === 'user') { 
            const newId = Date.now(); 
            const newSession = { id: newId, timestamp: newId, messages: [] }; 
            allChatSessions.unshift(newSession); 
            currentChatId = newId; 
        } 
        messages.push({ sender, text, images, isSystemMessage }); 
        refreshChat(); 
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }); 
    }
    
    // دالة لعرض الكود في حاوية خاصة
    function createCodeContainer(code, language = '') {
        const codeContainer = document.createElement('div');
        codeContainer.className = 'code-container';
        
        const codeHeader = document.createElement('div');
        codeHeader.className = 'code-header';
        
        const codeLanguage = document.createElement('span');
        codeLanguage.className = 'code-language';
        codeLanguage.textContent = language || 'كود';
        
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-code-btn';
        copyButton.innerHTML = '<i class="fas fa-copy"></i> نسخ';
        
        const codeContent = document.createElement('pre');
        codeContent.textContent = code;
        codeContent.style.margin = '0';
        codeContent.style.color = '#f8f8f2';
        codeContent.style.overflowX = 'auto';
        
        codeHeader.appendChild(codeLanguage);
        codeHeader.appendChild(copyButton);
        codeContainer.appendChild(codeHeader);
        codeContainer.appendChild(codeContent);
        
        // إضافة وظيفة النسخ
        copyButton.addEventListener('click', () => {
            navigator.clipboard.writeText(code).then(() => {
                const originalText = copyButton.innerHTML;
                copyButton.innerHTML = '<i class="fas fa-check"></i> تم النسخ!';
                copyButton.classList.add('copied');
                setTimeout(() => {
                    copyButton.innerHTML = originalText;
                    copyButton.classList.remove('copied');
                }, 2000);
            });
        });
        
        return codeContainer;
    }
    
    function typeWriterEffect(element, text) { 
        let i = 0; 
        element.innerHTML = ""; 
        
        function type() { 
            if (i < text.length) { 
                // التحقق إذا كان النص يحتوي على كود
                if (text.substring(i).startsWith('```')) {
                    const endIndex = text.indexOf('```', i + 3);
                    if (endIndex !== -1) {
                        const codeContent = text.substring(i + 3, endIndex);
                        const codeContainer = createCodeContainer(codeContent, '');
                        element.appendChild(codeContainer);
                        i = endIndex + 3;
                    } else {
                        element.innerHTML += text.charAt(i);
                        i++;
                    }
                } else {
                    element.innerHTML += text.charAt(i);
                    i++;
                }
                chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'auto' }); 
                setTimeout(type, 10);
            } else { 
                const messageElem = element.closest('.message'); 
                if(messageElem) addBotMessageActions(messageElem, text); 
            } 
        } 
        type(); 
    }
    
    function addBotMessageActions(messageElement, text) { 
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "message-actions";
        actionsDiv.innerHTML = ` 
            <button title="نسخ"><i class="fas fa-copy"></i></button> 
        `; 
        actionsDiv.querySelector('button[title="نسخ"]').onclick = () => { 
            navigator.clipboard.writeText(text); 
        }; 
        messageElement.appendChild(actionsDiv); 
    }
    
    function refreshChat() {
        chatContainer.innerHTML = "";
        messages.forEach((msg, index) => {
            const messageElem = document.createElement("div");
            messageElem.className = `message ${msg.sender}`;
            let senderName = msg.sender === "bot" ? botName : "أنت";
            
            const header = document.createElement("div");
            header.className = "message-header";
            const deleteButtonHTML = (msg.isInitialWelcome || msg.isSystemMessage) ? '' : `<i class="fas fa-trash delete-btn" title="حذف الرسالة"></i>`;
            header.innerHTML = `<span>${senderName}</span>${deleteButtonHTML}`;
            if (!msg.isInitialWelcome && !msg.isSystemMessage) {
                header.querySelector('.delete-btn').onclick = () => deleteMessage(index);
            }
            
            const contentDiv = document.createElement("div");
            contentDiv.className = "message-content";
            
            if(msg.text) {
                // معالجة النص لعرض الكود في حاوية خاصة
                let processedText = msg.text;
                const codeBlocks = processedText.match(/```[\s\S]*?```/g);
                
                if (codeBlocks) {
                    let lastIndex = 0;
                    codeBlocks.forEach((codeBlock) => {
                        const startIndex = processedText.indexOf(codeBlock, lastIndex);
                        const beforeCode = processedText.substring(lastIndex, startIndex);
                        
                        if (beforeCode) {
                            const textNode = document.createTextNode(beforeCode);
                            contentDiv.appendChild(textNode);
                        }
                        
                        const codeContent = codeBlock.replace(/```/g, '');
                        const codeContainer = createCodeContainer(codeContent, '');
                        contentDiv.appendChild(codeContainer);
                        
                        lastIndex = startIndex + codeBlock.length;
                    });
                    
                    if (lastIndex < processedText.length) {
                        const afterCode = processedText.substring(lastIndex);
                        const textNode = document.createTextNode(afterCode);
                        contentDiv.appendChild(textNode);
                    }
                } else {
                    const textNode = document.createTextNode(msg.text);
                    contentDiv.appendChild(textNode);
                }
            }
            
            if (msg.images && msg.images.length > 0) {
                msg.images.forEach(imgData => {
                    const imageElem = document.createElement('img');
                    imageElem.src = imgData;
                    imageElem.alt = "صورة مرسلة من المستخدم";
                    imageElem.className = 'sent-image';
                    imageElem.onclick = () => showFullscreenImage(imgData);
                    contentDiv.appendChild(imageElem);
                });
            }
            
            messageElem.appendChild(header);
            messageElem.appendChild(contentDiv);
            
            if(msg.sender === "bot" && !msg.isInitialWelcome && !msg.isSystemMessage) {
                addBotMessageActions(messageElem, msg.text);
            }
            
            chatContainer.appendChild(messageElem);
        });
        updateInitialViewState();
        saveAllChatSessionsToLocalStorage();
        autoResizeTextarea();
    }

    function showFullscreenImage(imageData) {
        document.getElementById('fullscreenImageView').src = imageData;
        document.getElementById('imageOverlay').style.display = 'flex';
    }

    function deleteMessage(index) { 
        messages.splice(index, 1); 
        refreshChat(); 
    }
    
    function deleteCurrentChat() { 
        settingsDropdown.style.display = 'none'; 
        if (!currentChatId) { 
            messages = []; 
            addWelcomeMessage(); 
            refreshChat(); 
            return; 
        } 
        if (confirm("هل أنت متأكد من حذف هذه المحادثة؟")) { 
            const sessionIndex = allChatSessions.findIndex(s => s.id === currentChatId); 
            if (sessionIndex > -1) { 
                allChatSessions.splice(sessionIndex, 1); 
            } 
            const nextSession = allChatSessions[0] || null; 
            loadChat(nextSession ? nextSession.id : null); 
        } 
    }
    
    async function fetchGeminiResponse(promptParts) {
        if (!geminiApiKey) throw new Error("API key is missing.");
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiApiKey}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: promptParts }] })
        });
        if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response received.";
    }

    async function processQueryWithAI(promptParts) { 
        updateInitialViewState(); 
        const typingIndicatorHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`; 
        const tempMsgId = `bot-msg-${Date.now()}`; 
        const messageElem = document.createElement("div"); 
        messageElem.className = `message bot`; 
        messageElem.id = tempMsgId; 
        messageElem.innerHTML = `<div class="message-header"><span>${botName}</span></div><div class="message-content">${typingIndicatorHTML}</div>`; 
        chatContainer.appendChild(messageElem); 
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }); 
        try { 
            const responseText = await fetchGeminiResponse(promptParts); 
            const finalMessageElement = document.getElementById(tempMsgId); 
            if (finalMessageElement) { 
                const contentDiv = finalMessageElement.querySelector('.message-content'); 
                typeWriterEffect(contentDiv, responseText); 
                messages.push({ sender: 'bot', text: responseText, images: [] }); 
                saveAllChatSessionsToLocalStorage(); 
            } 
        } catch (error) { 
            const errorElement = document.getElementById(tempMsgId); 
            if (errorElement) { 
                errorElement.querySelector('.message-content').innerHTML = `عذراً، واجهت مشكلة: ${error.message}`; 
            } 
            messages.push({ sender: 'bot', text: `عذراً، واجهت مشكلة: ${error.message}`, images: [], isSystemMessage: true }); 
            saveAllChatSessionsToLocalStorage(); 
        } 
    }

    async function sendMessage() {
        const messageText = userInput.value.trim();
        if (!messageText && attachedFiles.length === 0) return;
        
        addMessage("user", messageText, [...attachedFiles]);
        
        // تعليمات مختصرة وسريعة للبرمجة فقط
        const strictInstructions = `أنت خبير برمجة. أجِب بإيجاز وسرعة. ركز على الحلول العملية بدون مقدمات طويلة. إذا كان السؤال عن خطأ، قدم الحل مباشرة. إذا كان عن شرح، اشرح بأقل الكلمات. استخدم الرموز البرمجية عند الحاجة فقط. لا تقدم معلومات غير برمجية.`;
        
        const promptParts = [{ text: `${strictInstructions} السؤال: ${messageText}` }];
        attachedFiles.forEach(fileData => {
            promptParts.push({ inline_data: { mime_type: 'image/jpeg', data: fileData.split(',')[1] } });
        });
        
        userInput.value = "";
        attachedFiles = [];
        updateImagePreviews();
        autoResizeTextarea();
        updateSendOrVoiceButton();
        
        await processQueryWithAI(promptParts);
    }
    
    function autoResizeTextarea() { 
        userInput.style.height = 'auto'; 
        userInput.style.height = userInput.scrollHeight + 'px'; 
    }
    
    async function openCamera() { 
        try { 
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); 
            cameraView.srcObject = cameraStream; 
            cameraOverlay.style.display = "flex"; 
        } catch (err) { 
            console.error("Camera Error:", err); 
            alert("تعذر الوصول إلى الكاميرا. يرجى التأكد من الصلاحيات.");
        } 
    }
    
    function closeCamera() { 
        if (cameraStream) { 
            cameraStream.getTracks().forEach(track => track.stop()); 
            cameraStream = null; 
        } 
        cameraOverlay.style.display = 'none'; 
        previewOverlay.style.display = 'none'; 
    }
    
    function captureImage() { 
        const context = previewCanvas.getContext('2d'); 
        previewCanvas.width = cameraView.videoWidth; 
        previewCanvas.height = cameraView.videoHeight; 
        context.drawImage(cameraView, 0, 0); 
        document.querySelector('.shutter-flash').classList.add('active'); 
        setTimeout(() => { document.querySelector('.shutter-flash').classList.remove('active'); }, 500); 
        cameraOverlay.style.display = 'none'; 
        previewOverlay.style.display = 'flex'; 
    }
    
    function handleCameraPhotoSubmission() { 
        const base64ImageData = previewCanvas.toDataURL('image/jpeg', 0.9); 
        addFileToPreview(base64ImageData); 
        closeCamera(); 
    }
    
    function handleFileSelect(event) { 
        const file = event.target.files[0]; 
        if (!file) return; 
        const reader = new FileReader(); 
        reader.onload = (e) => addFileToPreview(e.target.result); 
        reader.readAsDataURL(file); 
        imageUploadInput.value = ''; 
    }
    
    function addFileToPreview(fileData) {
        if (attachedFiles.length >= 1) { 
            alert("عذراً، يمكنك إرفاق صورة واحدة فقط في كل مرة."); 
            return; 
        }
        
        attachedFiles.push(fileData);
        updateImagePreviews();
        updateSendOrVoiceButton();
    }

    function removeFileFromPreview(index) { 
        attachedFiles.splice(index, 1); 
        updateImagePreviews(); 
        updateSendOrVoiceButton();
    }
    
    function updateImagePreviews() { 
        if (attachedFiles.length > 0) { 
            imagePreviewContainer.style.display = 'flex'; 
            imagePreviewContainer.innerHTML = ''; 
            attachedFiles.forEach((fileData, index) => { 
                imagePreviewContainer.innerHTML += `<div class="preview-item"><img src="${fileData}"/><button class="remove-preview-btn" onclick="removeFileFromPreview(${index})">&times;</button></div>`; 
            }); 
        } else { 
            imagePreviewContainer.style.display = 'none'; 
        } 
    }
    
    function updateInitialViewState() {
        const hasUserMessages = messages.some(m => !m.isInitialWelcome);
        const isTyping = userInput.value.trim().length > 0;
        if (!hasUserMessages && currentChatId === null && !isTyping) {
            welcomeAnimation.style.display = 'flex';
            spaceBackground.style.display = 'block';
        } else {
            welcomeAnimation.style.display = 'none';
            spaceBackground.style.display = 'none';
        }
    }
    
    function openHistorySidebar() { 
        renderHistoryList(); 
        historySidebar.classList.add('open'); 
        sidebarOverlay.classList.add('open'); 
    }
    
    function closeHistorySidebar() { 
        historySidebar.classList.remove('open'); 
        sidebarOverlay.classList.remove('open'); 
    }
    
    function renderHistoryList() { 
        historyList.innerHTML = ''; 
        if (allChatSessions.length === 0) { 
            historyList.innerHTML = `<li style="cursor: default; opacity: 0.7; justify-content: center;">لا يوجد سجل بعد</li>`; 
            return; 
        } 
        allChatSessions.forEach(session => { 
            const li = document.createElement('li'); 
            if (session.id === currentChatId) { 
                li.classList.add('active'); 
            } 
            const firstUserMsg = session.messages.find(m => m.sender === 'user'); 
            const titleText = firstUserMsg ? (firstUserMsg.images.length > 0 ? `[صورة] ${firstUserMsg.text}`.trim() : firstUserMsg.text) : "محادثة جديدة"; 
            li.innerHTML = `<span class="history-item-title">${titleText}</span><button class="delete-history-item-btn" title="حذف المحادثة"><i class="fas fa-trash"></i></button>`; 
            li.querySelector('.history-item-title').addEventListener('click', () => { 
                if (session.id !== currentChatId) { 
                    loadChat(session.id); 
                } 
                closeHistorySidebar(); 
            }); 
            li.querySelector('.delete-history-item-btn').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                if (confirm("هل أنت متأكد من حذف هذه المحادثة؟")) { 
                    const sessionIndex = allChatSessions.findIndex(s => s.id === session.id); 
                    if (sessionIndex > -1) { 
                        allChatSessions.splice(sessionIndex, 1); 
                        if(session.id === currentChatId) { 
                            const nextSession = allChatSessions[0] || null; 
                            loadChat(nextSession ? nextSession.id : null); 
                        } 
                        saveAllChatSessionsToLocalStorage(); 
                        renderHistoryList(); 
                    } 
                } 
            }); 
            historyList.appendChild(li); 
        }); 
    }

    // جعل الدوال متاحة عالمياً للاستدعاء من HTML
    window.removeFileFromPreview = removeFileFromPreview;
    window.openCamera = openCamera;
  </script>
</body>
</html>
